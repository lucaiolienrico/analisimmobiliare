<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Piattaforma professionale per analisi investimenti immobiliari con calcolo ROI, Cashflow e Mutuo.">
    <title>InvestPro | Suite Analisi Immobiliare</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #020617;
            --primary: #10b981; --primary-hover: #059669; 
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: #334155; --radius: 8px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            --font-main: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-main); min-height: 100vh; display: flex; flex-direction: column; font-size: 16px; line-height: 1.5; }

        /* HEADER & NAVIGATION */
        header { background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 50; backdrop-filter: blur(12px); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.4rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; letter-spacing: -0.03em; }
        .logo span { color: white; }
        .user-menu { display: flex; align-items: center; gap: 1rem; }

        /* BUTTONS & TOOLBAR */
        .btn { padding: 0.6rem 1.2rem; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 0.9rem; border: 1px solid var(--border); background: var(--bg-card); color: white; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; text-decoration: none; }
        .btn:hover { background: var(--border); transform: translateY(-1px); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: #000; }
        .btn-info { background: rgba(59, 130, 246, 0.15); border-color: var(--info); color: var(--info); }
        
        .toolbar { max-width: 1400px; margin: 2rem auto 0; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .project-input { background: transparent; border: none; border-bottom: 2px solid var(--border); color: white; font-size: 1.5rem; font-weight: 700; width: 100%; max-width: 400px; padding: 0.5rem 0; }

        /* DASHBOARD LAYOUT */
        main { padding: 2rem 1rem; max-width: 1400px; margin: 0 auto; width: 100%; flex: 1; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; position: relative; box-shadow: var(--shadow); }
        .card-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: black; font-weight: 700; display: flex; align-items: center; justify-content: center; }

        /* FORMS & INPUTS */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 1.25rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.4rem; }
        label { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }
        input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 0.75rem; border-radius: 6px; font-family: inherit; }
        input:focus { border-color: var(--primary); }

        /* KPI & CHARTS */
        .kpi-container { background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; }
        .kpi-title { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; }
        .kpi-value { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .chart-wrapper { margin-top: 2rem; height: 250px; }

        /* DROPDOWN GEOGRAFICO */
        .dropdown-menu { position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 0 0 8px 8px; z-index: 50; max-height: 250px; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); }
        .dropdown-item { padding: 0.8rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .dropdown-item:hover { background: var(--primary); color: black; }

        /* PRO LOCK */
        .locked-blur { filter: blur(5px); pointer-events: none; opacity: 0.4; transition: all 0.3s; }
        .overlay-lock { position: absolute; inset: 0; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(2px); border-radius: 12px; }
        .is-unlocked .locked-blur { filter: none; pointer-events: auto; opacity: 1; }
        .is-unlocked .overlay-lock { display: none; }

        /* MODALS & UTILS */
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #loading-overlay.active { display: flex; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-card); border-left: 4px solid var(--primary); color: white; padding: 1rem 1.5rem; border-radius: 4px; transform: translateX(150%); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-backdrop.active { display: flex; }
        .modal-panel { background: var(--bg-card); width: 90%; max-width: 600px; border-radius: 16px; padding: 2rem; max-height: 85vh; overflow-y: auto; }

        @keyframes flash { 0% { background-color: var(--primary); color: black; } 100% { background-color: var(--bg-input); color: white; } }
        .input-updated { animation: flash 1.5s ease-out; }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div><p>Elaborazione...</p></div>
    <div id="toast-container"></div>

    <header>
        <div class="nav-container">
            <div class="logo"><i class="fa-solid fa-building-columns"></i> <span>InvestPro</span></div>
            <div class="user-menu">
                <div id="auth-guest"><button class="btn btn-primary" onclick="app.ui.openModal('modal-login')">Accedi</button></div>
                <div id="auth-user" class="hidden">
                    <span id="badge-plan" class="badge">FREE</span>
                    <span id="user-email-display" style="font-size: 0.8rem; margin: 0 10px;"></span>
                    <button class="btn" onclick="app.auth.logout()"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>
        </div>
    </header>

    <section class="toolbar">
        <input type="text" id="project-name" class="project-input" value="Nuova Analisi 2025" placeholder="Nome Progetto">
        <div style="display: flex; gap: 0.75rem;">
            <button class="btn btn-info" onclick="app.report.generate()"><i class="fa-solid fa-file-pdf"></i> Report</button>
            <button class="btn" onclick="app.data.openDealsList()"><i class="fa-solid fa-folder-open"></i> I Miei Deal</button>
            <button class="btn btn-primary" onclick="app.data.saveProject()"><i class="fa-solid fa-floppy-disk"></i> Salva</button>
        </div>
    </section>

    <main>
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header"><div class="step-circle">A</div><h3>Conto Economico</h3></div>
                
                <div class="form-group" style="margin-bottom: 1.5rem; position: relative;">
                    <label>Indirizzo Immobile</label>
                    <input type="text" id="geo-search" placeholder="Cerca città o indirizzo..." autocomplete="off">
                    <div id="geo-results" class="dropdown-menu hidden"></div>
                </div>

                <div class="input-grid">
                    <div class="form-group"><label>ADR Medio (€)</label><input type="number" id="adr" value="120"></div>
                    <div class="form-group"><label>Tassa Soggiorno (€)</label><input type="number" id="city-tax" value="2"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Commissioni OTA (%)</label><input type="number" id="portal-comm" value="18"></div>
                    <div class="form-group"><label>Cedolare / Tasse (%)</label><input type="number" id="tax-rate" value="21"></div>
                </div>
                <div class="input-grid">
                    <div class="form-group"><label>Costi Var. Notte (€)</label><input type="number" id="var-costs" value="15"></div>
                    <div class="form-group"><label>Occupazione (%)</label><input type="number" id="occ" value="65"></div>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;"><label>Costi Fissi Mensili (€)</label><input type="number" id="fixed-costs" value="600"></div>
                
                <div class="kpi-container"><span class="kpi-title">Utile Netto / Notte</span><span class="kpi-value" id="res-net-night">-- €</span></div>
                <div class="kpi-container" style="border-color: var(--primary);"><span class="kpi-title">MOL Mensile</span><span class="kpi-value" id="res-mol-month">-- €</span></div>

                <div class="chart-wrapper"><canvas id="profitChart"></canvas></div>
            </div>

            <div class="card" id="card-pro">
                <div class="overlay-lock">
                    <i class="fa-solid fa-lock" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
                    <h3>Funzionalità PRO</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Calcolo Mutuo, ROI e Report Avanzati.</p>
                    <button class="btn btn-primary" onclick="app.payment.start()">Sblocca Ora (9,90€)</button>
                </div>
                
                <div class="card-header"><div class="step-circle" style="background: white; color: black;">B</div><h3>Finanziario & Mutuo</h3></div>
                
                <div class="locked-blur">
                    <div class="form-group" style="margin-bottom: 1rem;"><label>Prezzo Acquisto (€)</label><input type="number" id="price" value="250000"></div>
                    <div class="input-grid">
                        <div class="form-group"><label>Ristrutturazione (€)</label><input type="number" id="reno" value="15000"></div>
                        <div class="form-group"><label>Spese Notaio (€)</label><input type="number" id="closing" value="10000"></div>
                    </div>
                    <div class="input-grid">
                        <div class="form-group"><label>LTV Mutuo (%)</label><input type="number" id="ltv" value="80"></div>
                        <div class="form-group"><label>Interesse (%)</label><input type="number" id="rate" value="3.5" step="0.1"></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;"><label>Durata (Anni)</label><input type="number" id="years" value="20"></div>
                    
                    <div class="kpi-container"><span class="kpi-title">Rata Mensile</span><span class="kpi-value" id="res-mortgage">-- €</span></div>
                    <div class="kpi-container" style="background: var(--primary); border: none;"><span class="kpi-title" style="color: black;">Cash Flow Netto</span><span class="kpi-value" id="res-cashflow" style="color: black;">-- €</span></div>

                    <div style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                        <div class="input-grid">
                            <div class="kpi-container" style="flex-direction: column; align-items: flex-start; gap: 4px; padding: 0.6rem;">
                                <span class="kpi-title" style="font-size: 0.6rem;">Equity (Cash)</span>
                                <span class="kpi-value" id="res-downpayment" style="font-size: 0.9rem;">-- €</span>
                            </div>
                            <div class="kpi-container" style="flex-direction: column; align-items: flex-start; gap: 4px; padding: 0.6rem;">
                                <span class="kpi-title" style="font-size: 0.6rem;">Interessi Tot.</span>
                                <span class="kpi-value" id="res-total-interest" style="font-size: 0.9rem;">-- €</span>
                            </div>
                        </div>
                        <button class="btn" style="width: 100%; justify-content: center; margin-top: 10px;" onclick="app.calc.showAmortization()">
                            <i class="fa-solid fa-table-list"></i> Piano Ammortamento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-login" class="modal-backdrop">
        <div class="modal-panel" style="text-align: center;">
            <h2 style="margin-bottom: 1.5rem;">Accedi</h2>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="app.auth.loginGoogle()">Google Login</button>
            <button class="btn btn-danger" style="width: 100%; margin-top: 1rem; justify-content: center;" onclick="app.ui.closeModal('modal-login')">Chiudi</button>
        </div>
    </div>

    <div id="modal-deals" class="modal-backdrop">
        <div class="modal-panel">
            <h2>Deal Salvati</h2>
            <div id="deals-container" style="margin-top: 1.5rem;"></div>
            <button class="btn" style="width: 100%; margin-top: 1.5rem; justify-content: center;" onclick="app.ui.closeModal('modal-deals')">Chiudi</button>
        </div>
    </div>

    <div id="modal-amortization" class="modal-backdrop">
        <div class="modal-panel" style="max-width: 800px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Piano di Ammortamento</h2>
                <button class="btn" onclick="app.ui.closeModal('modal-amortization')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="margin-top: 1.5rem; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead><tr style="border-bottom: 2px solid var(--border); text-align: left;"><th style="padding: 8px;">Anno</th><th style="padding: 8px;">Interessi</th><th style="padding: 8px;">Capitale</th><th style="padding: 8px;">Residuo</th></tr></thead>
                    <tbody id="amortization-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyDiGDvR2yXm0DE7vlJNGrIPQB0G-ntLHc0",
                authDomain: "analisimmobiliare-3b4a7.firebaseapp.com",
                projectId: "analisimmobiliare-3b4a7",
                storageBucket: "analisimmobiliare-3b4a7.firebasestorage.app",
                messagingSenderId: "29979040948",
                appId: "1:29979040948:web:597ea331e06567d8d50be1"
            },
            adminEmail: "lucaiolienrico1@gmail.com",
            stripeLink: "https://buy.stripe.com/test_4gM8wP85i5I0flc0PygjC01"
        };

        const state = { user: null, isPro: false, currentDocId: null, chartInstance: null };

        // --- CORE APPLICATION ---
        const app = {
            init: () => {
                if (!firebase.apps.length) firebase.initializeApp(CONFIG.firebase);
                app.services.auth = firebase.auth();
                app.services.db = firebase.firestore();
                
                app.auth.init();
                app.chart.init(); 
                app.calc.update();
                
                document.getElementById('geo-search').addEventListener('input', (e) => app.geo.debouncedSearch(e.target.value));
                document.querySelectorAll('input[type="number"]').forEach(i => i.addEventListener('input', app.calc.debouncedUpdate));
                
                window.addEventListener('click', (e) => {
                    if (!e.target.closest('#geo-search')) app.ui.toggleElement('geo-results', false);
                });
            },

            services: { auth: null, db: null },

            utils: {
                debounce: (func, wait) => {
                    let timeout;
                    return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); };
                },
                safeCall: async (fn, ctx) => {
                    app.ui.setLoading(true);
                    try { await fn(); } catch(e) { app.ui.showToast(e.message, 'error'); } finally { app.ui.setLoading(false); }
                },
                normalizeStr: (s) => s ? s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : ""
            },

            ui: {
                toggleElement: (id, show) => document.getElementById(id).classList.toggle('hidden', !show),
                openModal: (id) => document.getElementById(id).classList.add('active'),
                closeModal: (id) => document.getElementById(id).classList.remove('active'),
                setLoading: (show) => document.getElementById('loading-overlay').classList.toggle('active', show),
                showToast: (msg, type = 'info') => {
                    const t = document.createElement('div');
                    t.className = `toast show ${type}`;
                    t.textContent = msg;
                    document.getElementById('toast-container').appendChild(t);
                    setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
                },
                updateAuthUI: () => {
                    const u = state.user;
                    app.ui.toggleElement('auth-guest', !u);
                    app.ui.toggleElement('auth-user', !!u);
                    if(u) document.getElementById('user-email-display').textContent = u.email;
                },
                setProStatus: (active) => {
                    state.isPro = active;
                    const b = document.getElementById('badge-plan');
                    b.textContent = active ? "PRO" : "FREE";
                    b.style.background = active ? "var(--primary)" : "var(--border)";
                    document.getElementById('card-pro').classList.toggle('is-unlocked', active);
                }
            },

            geo: {
                // Motore Euristico 2025 per Tassa di Soggiorno
                getTaxData: (city, region, fullAddress) => {
                    const c = app.utils.normalizeStr(city);
                    const r = app.utils.normalizeStr(region);
                    const f = app.utils.normalizeStr(fullAddress);

                    const tier1 = ['roma', 'milano', 'firenze', 'venezia', 'napoli', 'bologna'];
                    if (tier1.includes(c)) return { range: "3,00€ - 10,00€", avg: 5.5, label: "Grandi Città d'Arte" };

                    const tier2 = ['torino', 'genova', 'verona', 'palermo', 'catania', 'bari', 'padova', 'trieste', 'brescia', 'lecce', 'rimini'];
                    if (tier2.includes(c)) return { range: "2,00€ - 6,00€", avg: 3.5, label: "Capoluogo / Città Media" };

                    const touristKwd = ['marina', 'lido', 'costa', 'riviera', 'montagna', 'isola', 'lake', 'garda'];
                    const touristReg = ['sardegna', 'sicilia', 'trentino', 'valle d\'aosta'];
                    if (touristKwd.some(k => f.includes(k)) || touristReg.some(reg => r.includes(reg))) {
                        return { range: "2,00€ - 5,00€", avg: 2.5, label: "Destinazione Turistica" };
                    }

                    return { range: "1,00€ - 2,00€", avg: 1.5, label: "Piccolo Comune / Altro" };
                },

                search: async (query) => {
                    if (query.length < 3) return;
                    const resDiv = document.getElementById('geo-results');
                    resDiv.innerHTML = '<div style="padding:10px; color:var(--text-muted);">Ricerca...</div>';
                    app.ui.toggleElement('geo-results', true);

                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5&countrycodes=it`);
                        const data = await res.json();
                        resDiv.innerHTML = '';
                        
                        data.forEach(item => {
                            const city = item.address.city || item.address.town || item.address.village || '';
                            const region = item.address.state || '';
                            const div = document.createElement('div');
                            div.className = 'dropdown-item';
                            div.textContent = `${city} (${region}) - ${item.address.road || ''}`;
                            div.onclick = () => {
                                document.getElementById('geo-search').value = div.textContent;
                                app.ui.toggleElement('geo-results', false);
                                
                                const tax = app.geo.getTaxData(city, region, item.display_name);
                                const taxInp = document.getElementById('city-tax');
                                taxInp.value = tax.avg;
                                
                                app.ui.showToast(`${city}: Fascia ${tax.label}. Suggerito ${tax.avg}€`, 'info');
                                
                                // Nota informativa dinamica
                                let info = document.getElementById('tax-note');
                                if (!info) {
                                    info = document.createElement('small');
                                    info.id = 'tax-note';
                                    info.style.cssText = "color:var(--text-muted); font-size:0.65rem; display:block; margin-top:4px;";
                                    taxInp.parentNode.appendChild(info);
                                }
                                info.textContent = `Range ${tax.label}: ${tax.range}`;
                                taxInp.classList.add('input-updated');
                                setTimeout(() => taxInp.classList.remove('input-updated'), 1500);

                                app.calc.update();
                            };
                            resDiv.appendChild(div);
                        });
                    } catch (e) { console.error(e); }
                },
                debouncedSearch: null
            },

            calc: {
                getVal: (id) => parseFloat(document.getElementById(id).value) || 0,
                format: (n) => n.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' }),
                update: () => {
                    const c = app.calc;
                    const totalRev = c.getVal('adr') * 365 * (c.getVal('occ')/100);
                    const ota = totalRev * (c.getVal('portal-comm')/100);
                    
                    // CORREZIONE FISCALE: Cedolare su Lordo
                    const taxes = totalRev * (c.getVal('tax-rate')/100);
                    
                    // CORREZIONE COSTI: Tassa soggiorno esclusa (partita di giro)
                    const opCosts = (c.getVal('var-costs') * 365 * (c.getVal('occ')/100)) + (c.getVal('fixed-costs') * 12);
                    
                    const mol = totalRev - ota - taxes - opCosts;

                    document.getElementById('res-mol-month').textContent = c.format(mol/12);
                    document.getElementById('res-net-night').textContent = c.format(mol / (365 * (c.getVal('occ')/100)) || 0);

                    if (state.chartInstance) {
                        state.chartInstance.data.datasets[0].data = [mol > 0 ? mol : 0, ota, taxes, opCosts];
                        state.chartInstance.update();
                    }

                    // FINANZA
                    const loan = c.getVal('price') * (c.getVal('ltv')/100);
                    const equity = (c.getVal('price') - loan) + c.getVal('reno') + c.getVal('closing');
                    const i = (c.getVal('rate')/100)/12, n = c.getVal('years')*12;
                    let m = (i > 0 && n > 0) ? loan * (i * Math.pow(1+i,n)) / (Math.pow(1+i,n)-1) : (n > 0 ? loan/n : 0);

                    document.getElementById('res-mortgage').textContent = c.format(m);
                    document.getElementById('res-cashflow').textContent = c.format((mol/12) - m);
                    document.getElementById('res-downpayment').textContent = c.format(equity);
                    document.getElementById('res-total-interest').textContent = c.format((m * n) - loan);
                },
                showAmortization: () => {
                    const c = app.calc;
                    const loan = c.getVal('price') * (c.getVal('ltv')/100);
                    const i = (c.getVal('rate')/100)/12, n = c.getVal('years')*12;
                    if(loan <= 0 || n <= 0) return;
                    
                    const mPay = loan * (i * Math.pow(1+i,n)) / (Math.pow(1+i,n)-1);
                    let bal = loan, html = '', yInt = 0, yPri = 0;

                    for(let m = 1; m <= n; m++) {
                        let iPart = bal * i, pPart = mPay - iPart;
                        bal -= pPart; yInt += iPart; yPri += pPart;
                        if(m % 12 === 0) {
                            html += `<tr><td>${m/12}</td><td>${c.format(yInt)}</td><td>${c.format(yPri)}</td><td>${c.format(bal > 0 ? bal : 0)}</td></tr>`;
                            yInt = 0; yPri = 0;
                        }
                    }
                    document.getElementById('amortization-body').innerHTML = html;
                    app.ui.openModal('modal-amortization');
                },
                debouncedUpdate: null
            },

            report: {
                generate: () => {
                    if (!state.isPro) return app.ui.showToast("Funzione disponibile solo per utenti PRO", "error");
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const c = app.calc;
                    const name = document.getElementById('project-name').value;

                    doc.setFillColor(15, 23, 42);
                    doc.rect(0, 0, 210, 30, 'F');
                    doc.setTextColor(16, 185, 129);
                    doc.setFontSize(18);
                    doc.text("INVESTPRO ANALISYS REPORT", 15, 20);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.text(`Progetto: ${name}`, 15, 45);
                    doc.text(`Indirizzo: ${document.getElementById('geo-search').value}`, 15, 52);

                    const rev = c.getVal('adr') * 365 * (c.getVal('occ')/100);
                    const ota = rev * (c.getVal('portal-comm')/100);
                    const taxes = rev * (c.getVal('tax-rate')/100);
                    const costs = (c.getVal('var-costs') * 365 * (c.getVal('occ')/100)) + (c.getVal('fixed-costs') * 12);
                    const mol = rev - ota - taxes - costs;

                    doc.autoTable({
                        startY: 65,
                        head: [['Descrizione', 'Valore Annuale']],
                        body: [
                            ['Fatturato Lordo Stimat.', c.format(rev)],
                            ['Commissioni Portali', c.format(ota)],
                            ['Imposte e Cedolare', c.format(taxes)],
                            ['Costi Operativi', c.format(costs)],
                            ['UTILE NETTO (MOL)', c.format(mol)]
                        ],
                        headStyles: { fillColor: [16, 185, 129] }
                    });

                    doc.save(`${name.replace(/\s+/g, '_')}_Report.pdf`);
                    app.ui.showToast("Report PDF generato con successo", "success");
                }
            },

            auth: {
                init: () => {
                    app.services.auth.onAuthStateChanged(async (u) => {
                        state.user = u;
                        app.ui.updateAuthUI();
                        if(u) {
                            const d = await app.services.db.collection('users').doc(u.uid).get();
                            app.ui.setProStatus(d.exists && d.data().plan === 'pro');
                        }
                    });
                },
                loginGoogle: async () => {
                    const p = new firebase.auth.GoogleAuthProvider();
                    try { await app.services.auth.signInWithPopup(p); app.ui.closeModal('modal-login'); } catch(e) { console.error(e); }
                },
                logout: () => app.services.auth.signOut().then(() => location.reload())
            },

            data: {
                saveProject: () => app.utils.safeCall(async () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    const inputs = {};
                    document.querySelectorAll('input').forEach(i => inputs[i.id] = i.value);
                    const payload = { uid: state.user.uid, name: document.getElementById('project-name').value, updatedAt: new Date(), inputs };
                    
                    if(state.currentDocId) await app.services.db.collection('projects').doc(state.currentDocId).update(payload);
                    else state.currentDocId = (await app.services.db.collection('projects').add(payload)).id;
                    
                    app.ui.showToast("Analisi salvata correttamente", "success");
                }, 'Save'),

                openDealsList: () => app.utils.safeCall(async () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    app.ui.openModal('modal-deals');
                    const snap = await app.services.db.collection('projects').where('uid','==',state.user.uid).get();
                    const cont = document.getElementById('deals-container');
                    cont.innerHTML = '';
                    snap.forEach(doc => {
                        const d = doc.data();
                        const row = document.createElement('div');
                        row.style.cssText = "padding:1rem; border-bottom:1px solid var(--border); cursor:pointer;";
                        row.textContent = d.name;
                        row.onclick = () => {
                            state.currentDocId = doc.id;
                            Object.keys(d.inputs).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = d.inputs[k]; });
                            app.calc.update(); app.ui.closeModal('modal-deals');
                        };
                        cont.appendChild(row);
                    });
                }, 'Load')
            },

            chart: {
                init: () => {
                    const ctx = document.getElementById('profitChart').getContext('2d');
                    state.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Utile', 'OTA', 'Tasse', 'Costi'],
                            datasets: [{ data: [0,0,0,0], backgroundColor: ['#10b981','#f59e0b','#ef4444','#3b82f6'], borderWidth: 0 }]
                        },
                        options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
                    });
                }
            },

            payment: {
                start: () => {
                    if(!state.user) return app.ui.openModal('modal-login');
                    window.open(`${CONFIG.stripeLink}?client_reference_id=${state.user.uid}`, '_blank');
                }
            }
        };

        app.calc.debouncedUpdate = app.utils.debounce(app.calc.update, 300);
        app.geo.debouncedSearch = app.utils.debounce(app.geo.search, 500);

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
